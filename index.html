<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Strahlensätze üben – Interaktives Tool</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#121a33;
      --panel2:#0f1730;
      --text:#e9ecf6;
      --muted:#aab3d6;
      --accent:#6ea8ff;
      --good:#2dd4bf;
      --bad:#fb7185;
      --warn:#fbbf24;
      --line:#2b3560;
      --chip:#1a2450;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 20% 0%, #132055 0%, var(--bg) 60%),
                  radial-gradient(900px 500px at 90% 10%, #1a2b66 0%, var(--bg) 65%);
      color: var(--text);
      font-family: var(--sans);
      line-height: 1.35;
    }
    header{
      padding: 18px 20px 8px;
      max-width: 1180px;
      margin: 0 auto;
    }
    header h1{
      font-size: 18px;
      margin: 0 0 6px 0;
      font-weight: 700;
      letter-spacing: .2px;
    }
    header p{
      margin:0;
      color: var(--muted);
      font-size: 13px;
    }

    .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 14px 20px 28px;
      display: grid;
      grid-template-columns: 1.2fr .9fr;
      gap: 16px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card .hd{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .hd .title{
      font-weight: 700;
      font-size: 13px;
      color: var(--text);
    }
    .hd .chips{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .chip{
      background: rgba(110,168,255,.10);
      border: 1px solid rgba(110,168,255,.25);
      color: #cfe1ff;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .canvasWrap{
      padding: 12px 14px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.08));
    }
    canvas{
      width: 100%;
      height: 420px;
      display:block;
      background: radial-gradient(800px 420px at 50% 40%, rgba(110,168,255,.08), rgba(0,0,0,.10));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
    }

    .side{
      display:flex;
      flex-direction: column;
      gap: 16px;
    }
    .section{
      padding: 12px 14px 14px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    select, input{
      width: 100%;
      box-sizing: border-box;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      padding: 9px 10px;
      border-radius: 10px;
      outline: none;
      font-size: 13px;
    }
    input::placeholder{ color: rgba(233,236,246,.45); }
    .row{
      display:flex;
      gap:10px;
      align-items:flex-end;
      flex-wrap:wrap;
    }
    .btn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(110,168,255,.14);
      color: #dbe7ff;
      padding: 9px 11px;
      border-radius: 10px;
      font-size: 13px;
      cursor: pointer;
      user-select:none;
      transition: transform .05s ease, background .12s ease;
    }
    .btn:hover{ background: rgba(110,168,255,.22); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background: rgba(255,255,255,.06);
    }
    .btn.secondary:hover{
      background: rgba(255,255,255,.10);
    }
    .btn.danger{
      background: rgba(251,113,133,.16);
      border-color: rgba(251,113,133,.25);
    }
    .btn.good{
      background: rgba(45,212,191,.16);
      border-color: rgba(45,212,191,.25);
    }
    .mono{
      font-family: var(--mono);
      font-size: 12px;
    }
    .task{
      margin-top: 10px;
      padding: 10px 10px;
      border-radius: 10px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
    }
    .task .q{
      font-weight: 700;
      margin-bottom: 6px;
    }
    .task .sub{
      color: var(--muted);
      font-size: 12px;
    }

    .msg{
      margin-top: 10px;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      min-height: 44px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .msg.good{ border-color: rgba(45,212,191,.35); background: rgba(45,212,191,.08); }
    .msg.bad{ border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.08); }
    .msg.warn{ border-color: rgba(251,191,36,.35); background: rgba(251,191,36,.08); }

    .formula{
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px dashed rgba(255,255,255,.18);
      color: var(--muted);
      background: rgba(0,0,0,.12);
    }
    .formula b{ color: var(--text); }
    .formula .line{ margin-top: 6px; }
    .small{
      font-size: 12px;
      color: var(--muted);
    }

    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
      canvas{ height: 360px; }
    }
  </style>
</head>
<body>
<header>
  <h1>Strahlensätze üben (1. und 2. Strahlensatz)</h1>
  <p>Generiert zufällige Aufgaben mit Skizze, prüft Eingaben, bietet Hinweise und zeigt bei Bedarf die Lösung.</p>
</header>

<div class="wrap">
  <!-- LEFT: Sketch -->
  <div class="card">
    <div class="hd">
      <div class="title">Skizze</div>
      <div class="chips">
        <span class="chip" id="chipType">—</span>
        <span class="chip" id="chipDiff">—</span>
      </div>
    </div>
    <div class="canvasWrap">
      <canvas id="cv" width="1100" height="520"></canvas>
      <div class="small" style="margin-top:10px;">
        Hinweis: Die Längenangaben sind so gewählt, dass sie mit den Strahlensätzen (Ähnlichkeit) lösbar sind.
      </div>
    </div>
  </div>

  <!-- RIGHT: Controls -->
  <div class="side">
    <div class="card">
      <div class="hd">
        <div class="title">Einstellungen & Aufgabe</div>
        <div class="chips">
          <span class="chip mono" id="chipUnknown">Unbekannt: —</span>
        </div>
      </div>
      <div class="section">
        <div class="grid">
          <div>
            <label for="mode">Aufgabentyp</label>
            <select id="mode">
              <option value="mix">Gemischt (1. oder 2. Strahlensatz)</option>
              <option value="satz1">Nur 1. Strahlensatz</option>
              <option value="satz2">Nur 2. Strahlensatz</option>
            </select>
          </div>
          <div>
            <label for="diff">Schwierigkeit</label>
            <select id="diff">
              <option value="easy">Einfach (meist ganze Zahlen)</option>
              <option value="mid" selected>Mittel (auch .5, mehr Varianten)</option>
              <option value="hard">Schwer (mehr Unbekannte möglich)</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="newBtn">Neue Aufgabe</button>
          <button class="btn secondary" id="hintBtn">Hinweis</button>
          <button class="btn secondary" id="solBtn">Lösung einblenden</button>
        </div>

        <div class="task" id="taskBox" aria-live="polite">
          <div class="q" id="taskQ">Klicke auf „Neue Aufgabe“.</div>
          <div class="sub" id="taskSub">—</div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div style="flex:1; min-width: 160px;">
            <label for="answer">Deine Lösung (Längeneinheiten)</label>
            <input id="answer" type="number" step="0.1" placeholder="z. B. 12.5" />
          </div>
          <button class="btn good" id="checkBtn">Prüfen</button>
        </div>

        <div class="msg" id="msgBox" aria-live="polite">
          <span id="msgText" class="small">—</span>
        </div>

        <div style="margin-top:12px;" class="formula">
          <div><b>Merksätze:</b></div>
          <div class="line mono">1. Strahlensatz: SA′ / SA = SB′ / SB</div>
          <div class="line mono">2. Strahlensatz: A′B′ / AB = SA′ / SA = SB′ / SB</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div class="title">Hilfestellung (Schritt-für-Schritt)</div>
      </div>
      <div class="section">
        <div id="helpText" class="small">
          Hinweise erscheinen hier. Klicke auf „Hinweis“, um einen passenden Tipp zu erhalten.
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // ---------- Utilities ----------
  const $ = (id) => document.getElementById(id);

  const round1 = (x) => Math.round(x * 10) / 10;

  function fmt(x){
    // show integer without .0; else one decimal
    const r = round1(x);
    return (Math.abs(r - Math.round(r)) < 1e-9) ? String(Math.round(r)) : r.toFixed(1);
  }

  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function approxEqual(a,b,tol){
    return Math.abs(a-b) <= tol;
  }

  // ---------- Canvas drawing ----------
  const cv = $("cv");
  const ctx = cv.getContext("2d");

  function clearCanvas(){
    ctx.clearRect(0,0,cv.width,cv.height);
  }

  function drawArrow(p1,p2,color,lineWidth=3){
    ctx.save();
    ctx.strokeStyle = color;
    ctx.lineWidth = lineWidth;
    ctx.lineCap = "round";
    ctx.beginPath();
    ctx.moveTo(p1.x,p1.y);
    ctx.lineTo(p2.x,p2.y);
    ctx.stroke();

    // arrow head
    const ang = Math.atan2(p2.y-p1.y, p2.x-p1.x);
    const L = 12;
    const a1 = ang + Math.PI*0.85;
    const a2 = ang - Math.PI*0.85;
    ctx.beginPath();
    ctx.moveTo(p2.x,p2.y);
    ctx.lineTo(p2.x + L*Math.cos(a1), p2.y + L*Math.sin(a1));
    ctx.lineTo(p2.x + L*Math.cos(a2), p2.y + L*Math.sin(a2));
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.fill();
    ctx.restore();
  }

  function drawLine(p1,p2,color,lineWidth=2, dashed=false){
    ctx.save();
    ctx.strokeStyle = color;
    ctx.lineWidth = lineWidth;
    ctx.lineCap = "round";
    if(dashed) ctx.setLineDash([8,8]);
    ctx.beginPath();
    ctx.moveTo(p1.x,p1.y);
    ctx.lineTo(p2.x,p2.y);
    ctx.stroke();
    ctx.restore();
  }

  function drawPoint(p, color, r=6){
    ctx.save();
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(p.x,p.y,r,0,Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  function drawText(text, x, y, color="#e9ecf6", size=14, align="center"){
    ctx.save();
    ctx.fillStyle = color;
    ctx.font = `600 ${size}px ${getComputedStyle(document.body).fontFamily}`;
    ctx.textAlign = align;
    ctx.textBaseline = "middle";
    ctx.fillText(text, x, y);
    ctx.restore();
  }

  function drawLabelBox(text, x, y, color, bg="rgba(0,0,0,.45)"){
    ctx.save();
    ctx.font = `700 13px ${getComputedStyle(document.body).fontFamily}`;
    const w = ctx.measureText(text).width + 14;
    const h = 22;
    ctx.fillStyle = bg;
    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.roundRect(x - w/2, y - h/2, w, h, 9);
    ctx.fill();
    ctx.stroke();
    ctx.fillStyle = color;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(text, x, y+0.5);
    ctx.restore();
  }

  // polyfill for roundRect if needed
  if(!CanvasRenderingContext2D.prototype.roundRect){
    CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
      const rr = Math.min(r, w/2, h/2);
      this.beginPath();
      this.moveTo(x+rr,y);
      this.arcTo(x+w,y, x+w,y+h, rr);
      this.arcTo(x+w,y+h, x,y+h, rr);
      this.arcTo(x,y+h, x,y, rr);
      this.arcTo(x,y, x+w,y, rr);
      this.closePath();
      return this;
    }
  }

  // ---------- Problem model ----------
  // Geometry: S at origin-ish. Ray1 horizontal right, Ray2 up-right.
  // Points A,B on first parallel; A',B' on second, scaling factor k about S.
  // Distances: SA, SB, SA', SB', and also AB, A'B' derived from coordinates.
  let state = null;

  function makeProblem() {
    const mode = $("mode").value;
    const diff = $("diff").value;

    let type = mode;
    if(mode === "mix") type = pick(["satz1","satz2"]);

    // difficulty -> available k values and unknown options
    let kChoices = [2,3];
    if(diff !== "easy") kChoices = [1.5, 2, 2.5, 3];
    if(diff === "hard") kChoices = [1.5, 2, 2.5, 3];

    const k = pick(kChoices);

    // choose SA, SB such that SA' and SB' are "nice"
    // If k has .5 => choose even SA/SB so product is integer
    const needsEven = Math.abs(k - Math.round(k)) > 1e-9;
    const baseMin = (diff === "easy") ? 4 : 4;
    const baseMax = (diff === "easy") ? 12 : 14;

    function randBase(){
      if(!needsEven) return randInt(baseMin, baseMax);
      let v = randInt(baseMin, baseMax);
      if(v % 2 === 1) v += 1;
      if(v > baseMax) v = baseMax - (baseMax % 2);
      return v;
    }

    const SA = randBase();
    let SB = randBase();
    // Avoid too symmetric sometimes
    if(SB === SA) SB = randBase();

    const SA1 = SA;
    const SB1 = SB;
    const SA2 = SA * k;
    const SB2 = SB * k;

    // geometry parameters
    const theta = (diff === "easy") ? (Math.PI * (25/180)) : (Math.PI * pick([25,30,35,40])/180);
    const scale = 22; // pixels per unit

    const S = {x: 120, y: 410};
    const d1 = {x: 1, y: 0};
    const d2 = {x: Math.cos(theta), y: -Math.sin(theta)};

    const A  = {x: S.x + SA1*scale*d1.x, y: S.y + SA1*scale*d1.y};
    const B  = {x: S.x + SB1*scale*d2.x, y: S.y + SB1*scale*d2.y};
    const Ap = {x: S.x + SA2*scale*d1.x, y: S.y + SA2*scale*d1.y};
    const Bp = {x: S.x + SB2*scale*d2.x, y: S.y + SB2*scale*d2.y};

    const AB  = Math.hypot(B.x-A.x, B.y-A.y)/scale;
    const ABp = Math.hypot(Bp.x-Ap.x, Bp.y-Ap.y)/scale;

    let unknown;
    if(type === "satz1"){
      unknown = pick(diff === "easy" ? ["SAp","SBp"] : ["SAp","SBp","SA","SB"]);
    } else {
      unknown = pick(diff === "easy" ? ["ABp","SAp"] : (diff === "mid"
                ? ["ABp","AB","SAp","SBp"]
                : ["ABp","AB","SAp","SBp","SA","SB"]));
    }

    const values = {
      SA: SA1, SB: SB1, SAp: SA2, SBp: SB2,
      AB: AB, ABp: ABp,
      k: k,
      theta: theta, scale: scale,
      pts: {S,A,B,Ap,Bp}
    };

    const shown = {...values};
    shown[unknown] = null;

    const sol = computeSolution(type, unknown, values);
    const hints = buildHints(type, unknown);

    return {
      type, diff, unknown,
      values, shown,
      solution: sol,
      hintIndex: 0,
      hints
    };
  }

  function computeSolution(type, unknown, v){
    const {SA, SB, SAp, SBp, AB, ABp, k} = v;

    const calc = {
      SA:   () => SAp / k,
      SB:   () => SBp / k,
      SAp:  () => SA * k,
      SBp:  () => SB * k,
      AB:   () => ABp / k,
      ABp:  () => AB * k
    };

    const x = calc[unknown] ? calc[unknown]() : NaN;
    return round1(x);
  }

  function buildHints(type, unknown){
    const base = [];
    base.push("Markiere die ähnlichen Dreiecke: Das kleine Dreieck (bei der ersten Parallelen) und das große Dreieck (bei der zweiten Parallelen) sind ähnlich.");
    if(type === "satz1"){
      base.push("Nutze den 1. Strahlensatz: SA′ / SA = SB′ / SB. Setze die bekannten Längen ein und löse nach der Unbekannten auf.");
      if(unknown === "SAp") base.push("Du suchst SA′. Forme um: SA′ = SA · (SB′/SB).");
      if(unknown === "SBp") base.push("Du suchst SB′. Forme um: SB′ = SB · (SA′/SA).");
      if(unknown === "SA")  base.push("Du suchst SA. Forme um: SA = SA′ · (SB/SB′).");
      if(unknown === "SB")  base.push("Du suchst SB. Forme um: SB = SB′ · (SA/SA′).");
    } else {
      base.push("Nutze den 2. Strahlensatz: A′B′ / AB = SA′ / SA = SB′ / SB. Alle Quotienten sind gleich (Ähnlichkeitsfaktor k).");
      if(unknown === "ABp") base.push("Du suchst A′B′. Bestimme k = SA′/SA (oder SB′/SB) und rechne: A′B′ = k · AB.");
      if(unknown === "AB")  base.push("Du suchst AB. Bestimme k = SA′/SA (oder SB′/SB) und rechne: AB = A′B′ / k.");
      if(unknown === "SAp") base.push("Du suchst SA′. Bestimme k z. B. über A′B′/AB und rechne: SA′ = k · SA.");
      if(unknown === "SBp") base.push("Du suchst SB′. Bestimme k z. B. über A′B′/AB und rechne: SB′ = k · SB.");
      if(unknown === "SA")  base.push("Du suchst SA. Bestimme k und rechne: SA = SA′ / k.");
      if(unknown === "SB")  base.push("Du suchst SB. Bestimme k und rechne: SB = SB′ / k.");
    }
    base.push("Plausibilitätscheck: Liegt die zweite Parallele weiter weg von S, müssen die ‚gestrichenen‘ Längen (′) größer sein als die ungestrichenen.");
    return base;
  }

  function buildDisplayLabels(st){
    const sh = st.shown;
    const labels = {
      SA:   sh.SA  == null ? "SA = x"   : `SA = ${fmt(sh.SA)}`,
      SB:   sh.SB  == null ? "SB = x"   : `SB = ${fmt(sh.SB)}`,
      SAp:  sh.SAp == null ? "SA′ = x"  : `SA′ = ${fmt(sh.SAp)}`,
      SBp:  sh.SBp == null ? "SB′ = x"  : `SB′ = ${fmt(sh.SBp)}`,
      AB:   sh.AB  == null ? "AB = x"   : `AB = ${fmt(sh.AB)}`,
      ABp:  sh.ABp == null ? "A′B′ = x" : `A′B′ = ${fmt(sh.ABp)}`
    };
    return labels;
  }

  function render(){
    if(!state){
      clearCanvas();
      return;
    }
    $("chipType").textContent = state.type === "satz1" ? "1. Strahlensatz" : "2. Strahlensatz";
    $("chipDiff").textContent = state.diff === "easy" ? "Einfach" : (state.diff === "mid" ? "Mittel" : "Schwer");
    $("chipUnknown").textContent = `Unbekannt: ${unknownPretty(state.unknown)}`;

    const labels = buildDisplayLabels(state);
    drawFigure(state, labels);
    updateTaskText();
    updateHelpText(false);
    setMessage("—", "");
    $("answer").value = "";
    $("answer").focus();
  }

  function unknownPretty(u){
    const map = {
      SA:"SA", SB:"SB", SAp:"SA′", SBp:"SB′", AB:"AB", ABp:"A′B′"
    };
    return map[u] || u;
  }

  function drawFigure(st, labels){
    clearCanvas();

    const {S,A,B,Ap,Bp} = st.values.pts;

    const colRay1 = "#6ea8ff";
    const colRay2 = "#7ee787";
    const colPar1 = "#fb7185";
    const colPar2 = "#fbbf24";
    const colDim  = "rgba(233,236,246,.65)";

    const ray1End = {x: S.x + 900, y: S.y};
    const ray2End = {x: S.x + 900*Math.cos(st.values.theta), y: S.y - 900*Math.sin(st.values.theta)};
    drawArrow(S, ray1End, colRay1, 3);
    drawArrow(S, ray2End, colRay2, 3);

    drawLine(A, B, colPar1, 4);
    drawLine(Ap, Bp, colPar2, 4);

    drawLine(A, Ap, "rgba(255,255,255,.08)", 2, true);
    drawLine(B, Bp, "rgba(255,255,255,.08)", 2, true);

    drawPoint(S, "#e9ecf6", 7);
    drawPoint(A, colRay1, 6);
    drawPoint(Ap, colRay1, 6);
    drawPoint(B, colRay2, 6);
    drawPoint(Bp, colRay2, 6);

    drawText("S", S.x-18, S.y+0, "#e9ecf6", 14, "center");
    drawText("A", A.x, A.y+18, "#cfe1ff", 13, "center");
    drawText("A′", Ap.x, Ap.y+18, "#cfe1ff", 13, "center");
    drawText("B", B.x-10, B.y-18, "#c8f7d1", 13, "center");
    drawText("B′", Bp.x-10, Bp.y-18, "#c8f7d1", 13, "center");

    labelSegmentMid(S, A, labels.SA, colRay1);
    labelSegmentMid(S, Ap, labels.SAp, colRay1);

    labelSegmentMid(S, B, labels.SB, colRay2);
    labelSegmentMid(S, Bp, labels.SBp, colRay2);

    if(st.type === "satz2"){
      labelSegmentMid(A, B, labels.AB, colPar1);
      labelSegmentMid(Ap, Bp, labels.ABp, colPar2);
    } else {
      if(st.unknown === "AB" || st.unknown === "ABp"){
        labelSegmentMid(A, B, labels.AB, colDim);
        labelSegmentMid(Ap, Bp, labels.ABp, colDim);
      }
    }

    drawLabelBox("g ∥ g′", (A.x+B.x)/2 - 10, (A.y+B.y)/2 + 36, "rgba(233,236,246,.85)");
  }

  function labelSegmentMid(P,Q,text,color){
    const mx = (P.x+Q.x)/2;
    const my = (P.y+Q.y)/2;
    const dx = Q.x-P.x, dy = Q.y-P.y;
    const len = Math.hypot(dx,dy) || 1;
    const nx = -dy/len, ny = dx/len;
    const off = 18;

    drawLabelBox(text, mx + nx*off, my + ny*off, color);
  }

  // ---------- Task text / UI text ----------
  function updateTaskText(){
    const u = state.unknown;

    const q = `Berechne ${unknownPretty(u)}.`;

    $("taskQ").textContent = q;
    $("taskSub").textContent = ""; // kein Zusatz unter der Aufgabenstellung
  }

  function updateHelpText(advance){
    if(!state) return;
    if(advance){
      state.hintIndex = Math.min(state.hintIndex + 1, state.hints.length - 1);
    }
    const idx = state.hintIndex;
    const total = state.hints.length;

    $("helpText").innerHTML = `
      <div style="margin-bottom:8px;">
        <span class="chip mono">Hinweis ${idx+1} / ${total}</span>
      </div>
      <div>${escapeHtml(state.hints[idx])}</div>
    `;
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function setMessage(text, kind){
    const box = $("msgBox");
    const t = $("msgText");
    box.classList.remove("good","bad","warn");
    if(kind) box.classList.add(kind);
    t.textContent = text;
  }

  // ---------- Checking ----------
  function checkAnswer(){
    if(!state){
      setMessage("Erzeuge zuerst eine Aufgabe über „Neue Aufgabe“.", "warn");
      return;
    }
    const raw = $("answer").value;
    if(raw === "" || raw == null){
      setMessage("Bitte gib eine Zahl ein.", "warn");
      return;
    }
    const user = Number(raw);
    if(!Number.isFinite(user)){
      setMessage("Eingabe ist keine gültige Zahl.", "warn");
      return;
    }

    const sol = state.solution;
    const tol = 0.15;
    if(approxEqual(user, sol, tol)){
      setMessage(`Richtig. ${unknownPretty(state.unknown)} = ${fmt(sol)}.`, "good");
    } else {
      const delta = round1(Math.abs(user - sol));
      setMessage(`Noch nicht korrekt. Abweichung ca. ${fmt(delta)}. Nutze ggf. „Hinweis“ oder „Lösung einblenden“.`, "bad");
    }
  }

  function showSolution(){
    if(!state){
      setMessage("Erzeuge zuerst eine Aufgabe über „Neue Aufgabe“.", "warn");
      return;
    }
    const sol = state.solution;
    setMessage(`Lösung: ${unknownPretty(state.unknown)} = ${fmt(sol)}.`, "warn");
    const worked = buildWorkedSolution(state);
    $("helpText").innerHTML = worked;
  }

  function buildWorkedSolution(st){
    const v = st.values;
    const u = st.unknown;

    const SA = fmt(v.SA), SB = fmt(v.SB), SAp = fmt(v.SAp), SBp = fmt(v.SBp);
    const AB = fmt(v.AB), ABp = fmt(v.ABp);
    const sol = fmt(st.solution);

    let lines = [];
    if(st.type === "satz1"){
      lines.push(`<div class="mono">1. Strahlensatz: SA′ / SA = SB′ / SB</div>`);
      if(u === "SAp"){
        lines.push(`<div class="mono">SA′ = SA · (SB′/SB) = ${SA} · (${SBp}/${SB}) = ${sol}</div>`);
      } else if(u === "SBp"){
        lines.push(`<div class="mono">SB′ = SB · (SA′/SA) = ${SB} · (${SAp}/${SA}) = ${sol}</div>`);
      } else if(u === "SA"){
        lines.push(`<div class="mono">SA = SA′ · (SB/SB′) = ${SAp} · (${SB}/${SBp}) = ${sol}</div>`);
      } else if(u === "SB"){
        lines.push(`<div class="mono">SB = SB′ · (SA/SA′) = ${SBp} · (${SA}/${SAp}) = ${sol}</div>`);
      } else {
        lines.push(`<div class="mono">Setze bekannte Werte ein und löse nach ${unknownPretty(u)}.</div>`);
      }
    } else {
      lines.push(`<div class="mono">2. Strahlensatz: A′B′/AB = SA′/SA = SB′/SB</div>`);
      lines.push(`<div class="mono">Ähnlichkeitsfaktor: k = SA′/SA = ${SAp}/${SA} = ${fmt(v.k)}</div>`);
      if(u === "ABp"){
        lines.push(`<div class="mono">A′B′ = k · AB = ${fmt(v.k)} · ${AB} = ${sol}</div>`);
      } else if(u === "AB"){
        lines.push(`<div class="mono">AB = A′B′ / k = ${ABp} / ${fmt(v.k)} = ${sol}</div>`);
      } else if(u === "SAp"){
        lines.push(`<div class="mono">SA′ = k · SA = ${fmt(v.k)} · ${SA} = ${sol}</div>`);
      } else if(u === "SBp"){
        lines.push(`<div class="mono">SB′ = k · SB = ${fmt(v.k)} · ${SB} = ${sol}</div>`);
      } else if(u === "SA"){
        lines.push(`<div class="mono">SA = SA′ / k = ${SAp} / ${fmt(v.k)} = ${sol}</div>`);
      } else if(u === "SB"){
        lines.push(`<div class="mono">SB = SB′ / k = ${SBp} / ${fmt(v.k)} = ${sol}</div>`);
      } else {
        lines.push(`<div class="mono">Setze bekannte Werte ein und löse nach ${unknownPretty(u)}.</div>`);
      }
      lines.push(`<div class="small" style="margin-top:8px;color:rgba(233,236,246,.65)">Hinweis: In der Skizze sind AB und A′B′ konsistent zur Ähnlichkeit konstruiert.</div>`);
    }

    return `
      <div style="margin-bottom:8px;"><span class="chip mono">Ausgearbeitete Lösung</span></div>
      ${lines.map(x=>`<div style="margin-top:6px;">${x}</div>`).join("")}
    `;
  }

  function applyVisibility(st){
    const sh = {
      SA: st.values.SA,
      SB: st.values.SB,
      SAp: st.values.SAp,
      SBp: st.values.SBp,
      AB: st.values.AB,
      ABp: st.values.ABp,
    };
    sh[st.unknown] = null;
    st.shown = sh;
  }

  $("newBtn").addEventListener("click", () => {
    state = makeProblem();
    applyVisibility(state);
    render();
  });

  $("checkBtn").addEventListener("click", checkAnswer);
  $("answer").addEventListener("keydown", (e) => {
    if(e.key === "Enter") checkAnswer();
  });

  $("hintBtn").addEventListener("click", () => {
    if(!state){
      setMessage("Erzeuge zuerst eine Aufgabe über „Neue Aufgabe“.", "warn");
      return;
    }
    updateHelpText(true);
  });

  $("solBtn").addEventListener("click", showSolution);

  render();
})();
</script>
</body>
</html>
